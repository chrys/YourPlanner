# OpenAPI draft for Template-First Order and Dynamic Pricing  # [added]
openapi: 3.0.3  # [added]
info:  # [added]
  title: YourPlanner Basket API  # [added]
  version: 0.1.0  # [added]
paths:  # [added]
  /api/basket:  # [added]
    get:  # [added]
      summary: Get current draft order (basket)  # [added]
      responses:  # [added]
        '200':  # [modified]
          description: OK  # [added]
          content:  # [added]
            application/json:  # [added]
              schema: { $ref: '#/components/schemas/Basket' }  # [added]
              examples:  # [added]
                sample:  # [added]
                  value:  # [added]
                    order_id: 123  # [added]
                    currency: EUR  # [added]
                    template:  # [added]
                      template_id: 10  # [added]
                      name: "Wedding Classic"  # [added]
                      guest_count: 120  # [added]
                      unit_price: { amount: "15.00", currency: EUR }  # [added]
                      subtotal: { amount: "1800.00", currency: EUR }  # [added]
                    services:  # [added]
                      - service_id: 7  # [added]
                        name: "Catering"  # [added]
                        professional_id: 33  # [added]
                        price: { amount: "500.00", currency: EUR }  # [added]
                        items:  # [added]
                          - item_id: 201  # [added]
                            name: "Extra desserts"  # [added]
                            unit_price: { amount: "3.00", currency: EUR }  # [added]
                            quantity: 120  # [added]
                            subtotal: { amount: "360.00", currency: EUR }  # [added]
                        subtotal: { amount: "860.00", currency: EUR }  # [added]
                    items:  # [added]
                      - item_id: 99  # [added]
                        name: "Welcome drinks"  # [added]
                        unit_price: { amount: "2.50", currency: EUR }  # [added]
                        quantity: 120  # [added]
                        subtotal: { amount: "300.00", currency: EUR }  # [added]
                    totals:  # [added]
                      template_total: { amount: "1800.00", currency: EUR }  # [added]
                      services_total: { amount: "860.00", currency: EUR }  # [added]
                      items_total: { amount: "300.00", currency: EUR }  # [added]
                      grand_total: { amount: "2960.00", currency: EUR }  # [added]
  /api/basket/template:  # [added]
    post:  # [added]
      summary: Add/replace Template and set guest count  # [added]
      requestBody:  # [added]
        required: true  # [added]
        content:  # [added]
          application/json:  # [added]
            schema:  # [added]
              type: object  # [added]
              properties:  # [added]
                template_id: { type: integer }  # [added]
                guest_count: { type: integer, minimum: 1 }  # [added]
      responses:  # [added]
        '200':  # [modified]
          description: Updated basket  # [added]
          content: { application/json: { schema: { $ref: '#/components/schemas/Basket' } } }  # [added]
        '400': { description: Invalid template or currency mismatch, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }  # [added]
  /api/basket/template/guests:  # [added]
    patch:  # [added]
      summary: Update guest count and recalc template price  # [added]
      requestBody:  # [added]
        required: true  # [added]
        content:  # [added]
          application/json:  # [added]
            schema: { type: object, properties: { guest_count: { type: integer, minimum: 1 } } }  # [added]
      responses:  # [modified]
        '200': { description: Updated basket, content: { application/json: { schema: { $ref: '#/components/schemas/Basket' } } } }  # [added]
        '400': { description: Invalid guest count, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }  # [added]
  /api/basket/services:  # [added]
    post:  # [added]
      summary: Add an add-on Service  # [added]
      requestBody:  # [added]
        required: true  # [added]
        content:  # [added]
          application/json:  # [added]
            schema:  # [added]
              type: object  # [added]
              properties:  # [added]
                service_id: { type: integer }  # [added]
      responses:  # [modified]
        '200': { description: Updated basket, content: { application/json: { schema: { $ref: '#/components/schemas/Basket' } } } }  # [added]
        '400': { description: Service not compatible (currency/professional), content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }  # [added]
  /api/basket/services/{service_id}/items/{item_id}:  # [added]
    patch:  # [added]
      summary: Update item quantity for a Service  # [added]
      parameters:  # [added]
        - { name: service_id, in: path, required: true, schema: { type: integer } }  # [added]
        - { name: item_id, in: path, required: true, schema: { type: integer } }  # [added]
      requestBody:  # [added]
        required: true  # [added]
        content:  # [added]
          application/json:  # [added]
            schema: { type: object, properties: { quantity: { type: integer, minimum: 0 } } }  # [added]
      responses:  # [modified]
        '200': { description: Updated basket, content: { application/json: { schema: { $ref: '#/components/schemas/Basket' } } } }  # [added]
        '400': { description: Item not compatible or invalid quantity, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }  # [added]
  /api/basket/items:  # [added]
    post:  # [added]
      summary: Add an individual Item  # [added]
      requestBody:  # [added]
        required: true  # [added]
        content:  # [added]
          application/json:  # [added]
            schema: { type: object, properties: { item_id: { type: integer }, quantity: { type: integer, minimum: 1 } } }  # [added]
      responses:  # [modified]
        '200': { description: Updated basket, content: { application/json: { schema: { $ref: '#/components/schemas/Basket' } } } }  # [added]
        '400': { description: Item not compatible or invalid quantity, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }  # [added]
  /api/basket/items/{item_id}:  # [added]
    patch:  # [added]
      summary: Update quantity for an individual Item  # [added]
      parameters: [ { name: item_id, in: path, required: true, schema: { type: integer } } ]  # [added]
      requestBody: { required: true, content: { application/json: { schema: { type: object, properties: { quantity: { type: integer, minimum: 0 } } } } } }  # [added]
      responses:  # [modified]
        '200': { description: Updated basket, content: { application/json: { schema: { $ref: '#/components/schemas/Basket' } } } }  # [added]
        '400': { description: Invalid quantity, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }  # [added]
  /api/basket/verify:  # [added]
    post:  # [added]
      summary: Verify basket and recompute totals  # [added]
      responses:  # [modified]
        '200': { description: Updated basket with recalculated totals, content: { application/json: { schema: { $ref: '#/components/schemas/Basket' } } } }  # [added]
        '400': { description: Basket invalid, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }  # [added]

components:  # [added]
  schemas:  # [added]
    Currency:  # [added]
      type: string  # [added]
      description: ISO 4217 currency code  # [added]
      pattern: '^[A-Z]{3}$'  # [added]
      example: EUR  # [added]
    Money:  # [added]
      type: object  # [added]
      properties:  # [added]
        amount:  # [added]
          type: string  # [added]
          pattern: '^-?\d{1,9}(\.\d{2})?$'  # [added]
          description: Decimal string with 2 fraction digits  # [added]
        currency: { $ref: '#/components/schemas/Currency' }  # [added]
      required: [ amount, currency ]  # [added]
    ItemLine:  # [added]
      type: object  # [added]
      properties:  # [added]
        item_id: { type: integer }  # [added]
        name: { type: string }  # [added]
        unit_price: { $ref: '#/components/schemas/Money' }  # [added]
        quantity: { type: integer, minimum: 0 }  # [added]
        subtotal: { $ref: '#/components/schemas/Money' }  # [added]
      required: [ item_id, name, unit_price, quantity, subtotal ]  # [added]
    ServiceLine:  # [added]
      type: object  # [added]
      properties:  # [added]
        service_id: { type: integer }  # [added]
        name: { type: string }  # [added]
        professional_id: { type: integer }  # [added]
        price: { $ref: '#/components/schemas/Money' }  # [added]
        items:  # [added]
          type: array  # [added]
          items: { $ref: '#/components/schemas/ItemLine' }  # [added]
        subtotal: { $ref: '#/components/schemas/Money' }  # [added]
      required: [ service_id, name, professional_id, price, items, subtotal ]  # [added]
    TemplateSelection:  # [added]
      type: object  # [added]
      properties:  # [added]
        template_id: { type: integer }  # [added]
        name: { type: string }  # [added]
        guest_count: { type: integer, minimum: 1 }  # [added]
        unit_price: { $ref: '#/components/schemas/Money' }  # [added]
        subtotal: { $ref: '#/components/schemas/Money' }  # [added]
      required: [ template_id, name, guest_count, unit_price, subtotal ]  # [added]
    BasketTotals:  # [added]
      type: object  # [added]
      properties:  # [added]
        template_total: { $ref: '#/components/schemas/Money' }  # [added]
        services_total: { $ref: '#/components/schemas/Money' }  # [added]
        items_total: { $ref: '#/components/schemas/Money' }  # [added]
        grand_total: { $ref: '#/components/schemas/Money' }  # [added]
        recurring_total: { $ref: '#/components/schemas/Money' }  # [added]
      required: [ template_total, services_total, items_total, grand_total ]  # [added]
    Basket:  # [added]
      type: object  # [added]
      properties:  # [added]
        order_id: { type: integer }  # [added]
        currency: { $ref: '#/components/schemas/Currency' }  # [added]
        template: { $ref: '#/components/schemas/TemplateSelection' }  # [added]
        services:  # [added]
          type: array  # [added]
          items: { $ref: '#/components/schemas/ServiceLine' }  # [added]
        items:  # [added]
          type: array  # [added]
          items: { $ref: '#/components/schemas/ItemLine' }  # [added]
        totals: { $ref: '#/components/schemas/BasketTotals' }  # [added]
        warnings: { type: array, items: { type: string } }  # [added]
        errors: { type: array, items: { type: string } }  # [added]
      required: [ order_id, currency, totals ]  # [added]
    Error:  # [added]
      type: object  # [added]
      properties:  # [added]
        message: { type: string }  # [added]
        code: { type: string }  # [added]
        details: { type: object, additionalProperties: true }  # [added]
      required: [ message ]  # [added]
