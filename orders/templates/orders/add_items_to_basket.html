{% extends "core/base.html" %}
{% load i18n %}
{% block title %}{{ page_title|default:"Add Items to Basket" }}{% endblock %}

{% block content %}
{% load static %}

<main class="container mt-4">
    <div id="add-items-app">
        <h2 class="mb-4">{{ page_title|default:"Add Items to Your Basket" }}</h2>

        {% include "_messages.html" %}

        <form id="add-items-form" method="post">
            {% csrf_token %}
            <!-- Services Section -->
            <div v-for="service in servicesData" :key="service.id" class="service-section card mb-4">
                <div class="card-header bg-light">
                    <h3 class="h5 mb-0">
                        [[ service.title ]]
                        <small class="text-muted">by [[ service.professional_name ]]</small>
                    </h3>
                </div>
                <div class="card-body p-0">
                    <table class="items-table table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 25%;">{% trans "Item" %}</th>
                                <th style="width: 35%;">{% trans "Description" %}</th>
                                <th style="width: 20%;">{% trans "Price" %}</th>
                                <th style="width: 20%;" class="text-center">{% trans "Quantity" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Item-level prices -->
                            <template v-for="item in service.items" :key="item.id">
                                <!-- Show row for each price, or one row if no prices -->
                                <tr v-if="item.prices.length === 0">
                                    <td><strong>[[ item.title ]]</strong></td>
                                    <td>[[ item.description ]]</td>
                                    <td><span class="text-muted">(No prices available)</span></td>
                                    <td class="text-center"><span class="text-muted">-</span></td>
                                </tr>
                                <tr v-for="price in item.prices" :key="price.id" v-else>
                                    <td><strong>[[ item.title ]]</strong></td>
                                    <td>[[ item.description ]]</td>
                                    <td>
                                        <span style="color:#e88ea1;">[[ price.amount ]] [[ price.currency ]]</span>
                                        <small class="d-block text-muted">([[ price.frequency ]])</small>
                                        {% if price.description %}
                                        <small class="d-block text-muted"><em>[[ price.description ]]</em></small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <input type="number"
                                               :name="'quantity_' + price.id"
                                               min="0"
                                               class="form-control form-control-sm mx-auto"
                                               style="width: 80px;"
                                               v-model.number="quantities[price.id]"
                                               @input="validateQuantity(price.id)">
                                    </td>
                                </tr>
                            </template>
                            <!-- Service-level prices - show all available service prices -->
                            <tr v-for="price in (service.service_prices || [])" :key="'service_price_' + price.id">
                                <td><strong>[[ service.title ]]</strong></td>
                                <td>[[ price.description ]]</td>
                                <td>
                                    <span style="color:#e88ea1;">[[ price.amount ]] [[ price.currency ]]</span>
                                    <small class="d-block text-muted">([[ price.frequency ]])</small>
                                </td>
                                <td class="text-center">
                                    <input type="number"
                                           :name="'quantity_' + price.id"
                                           min="0"
                                           class="form-control form-control-sm mx-auto"
                                           style="width: 80px;"
                                           v-model.number="quantities[price.id]"
                                           @input="validateQuantity(price.id)">
                                </td>
                            </tr>
                            <!-- Show message only if service has no items and no service prices -->
                            <tr v-if="service.items.length === 0 && (!service.service_prices || service.service_prices.length === 0)">
                                <td colspan="4" class="text-center text-muted py-3">{% trans "No items available for this service." %}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="text-end my-4">
                <!-- CHANGED: "Add to Basket" button instead of "Update Order Items" -->
                <button type="submit" class="btn btn-lg basket-btn-vue">{% trans "Add to Basket" %}</button>
                <a href="{% url 'orders:basket' %}" class="btn btn-lg btn-secondary ms-2">{% trans "Back to Basket" %}</a>
            </div>
        </form>
    </div>
</main>

<script>
window.__servicesData__ = {{ services_json|safe }};
window.__currentQuantities__ = {{ current_quantities_json|safe }};
</script>

<script>
// CHANGED: Vue app for customer-focused item selection
if (document.getElementById('add-items-app')) {
  const { createApp, ref, onMounted } = Vue;

  createApp({
    delimiters: ['[[', ']]'],
    setup() {
        const servicesData = ref([]);
        const quantities = ref({}); // Store quantities by price_id
        
        onMounted(() => {
            servicesData.value = window.__servicesData__;
            const initialQuantities = window.__currentQuantities__;
            servicesData.value.forEach(service => {
                service.items.forEach(item => {
                    item.prices.forEach(price => {
                        quantities.value[price.id] = initialQuantities[price.id] || 0;
                    });
                });
                if (service.service_prices && service.service_prices.length > 0) {
                    service.service_prices.forEach(price => {
                        quantities.value[price.id] = initialQuantities[price.id] || 0;
                    });
                }
            });
        });

        function validateQuantity(priceId) {
            if (quantities.value[priceId] < 0 || isNaN(quantities.value[priceId])) {
                quantities.value[priceId] = 0;
            }
        }

        // Expose to template
        return {
            servicesData,
            quantities,
            validateQuantity,
        };
    }
  }).mount('#add-items-app');
}
</script>

<style>
.basket-btn-vue {
    background: #e88ea1;
    color: #fff;
    border: none;
    padding: 10px 22px;
    border-radius: 5px;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
}
.basket-btn-vue:hover {
    background: #fff;
    color: #e88ea1;
    border: 1px solid #e88ea1;
}

.service-section {
    border-left: 4px solid #e88ea1;
}

.service-section .card-header {
    background-color: #f8f0f5 !important;
    border-bottom: 2px solid #e88ea1;
}

.items-table {
    margin-bottom: 0;
}
</style>
{% endblock %}
