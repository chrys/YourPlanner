{% extends "core/base.html" %}
{% load static %}
{% load i18n %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ page_title|default:"My Basket" }}{% endblock %}</title>

    <!-- Bootstrap CSS (if not already included in base.html) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome (for icons) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

    <!-- Custom styles -->
    <link rel="stylesheet" href="{% static 'core/css/home.css' %}"> 
</head>
<body>

{% block content %}
<main class="container mt-4">
    <div id="basket-app" class="card shadow-sm">
        <div class="card-header bg-light">
            <h2 class="h4-mb-0">{{ page_title|default:"My Basket" }}</h2>
        </div>
        <div class="card-body p-4">
            {% include "_messages.html" %}

            {% if order %}
                <!-- ORDER DETAILS -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><strong>{% trans "Order ID" %}:</strong> {{ order.pk_formatted }}</p>
                        <p><strong>{% trans "Date Placed" %}:</strong> {{ order.created_at|date:"Y-m-d H:i" }}</p>
                        <p><strong>{% trans "Status" %}:</strong> <span class="badge bg-info text-dark">{{ order.get_status_display }}</span></p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <p><strong>{% trans "To" %}:</strong> {{ request.user.get_full_name|default:request.user.username }}</p>
                        {% if request.user.customer_profile.address %}
                        <p>{{ request.user.customer_profile.address|linebreaksbr }}</p>
                        {% endif %}
                    </div>
                </div>

                <!-- PACKAGE SNAPSHOT -->
                {% if order.template %}
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-box"></i> {% trans "Package" %}: {{ order.template.title }}
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p><strong>{% trans "Base Price:" %}</strong> {{ order.template.base_price|floatformat:2 }} {{ order.currency }}</p>
                                <p><strong>{% trans "Guests:" %}</strong> {{ order.template_guest_count }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>{% trans "Package Price:" %}</strong></p>
                                <p class="h5 text-primary">{{ order.template_total_amount|floatformat:2 }} {{ order.currency }}</p>
                            </div>
                        </div>
                        
                        <!-- INCLUDED SERVICES -->
                        <div class="mt-3">
                            <h5>{% trans "Included Services & Items" %}</h5>
                            <ul class="list-group list-group-flush">
                                {% for service in order.template.services.all %}
                                    <li class="list-group-item">
                                        <strong>{{ service.title }}</strong>
                                        {% if service.items.all %}
                                            <ul class="list-unstyled ms-3 mt-2">
                                                {% for item in service.items.all %}
                                                    <li><small>â€¢ {{ item.title }}</small></li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>

                        <!-- PACKAGE ACTIONS -->
                        <div class="mt-3 pt-2 border-top">
                            <button type="button" class="btn btn-sm btn-outline-info" 
                                    id="adjust-guests-btn-{{ order.pk }}" 
                                    data-bs-toggle="collapse" 
                                    data-bs-target="#adjust-guests-form-{{ order.pk }}" 
                                    aria-expanded="false" 
                                    aria-controls="adjust-guests-form-{{ order.pk }}">
                                <i class="fas fa-users"></i> {% trans "Adjust Guests" %}
                            </button>
                            
                            <form method="post" action="{% url 'orders:remove_template' %}" class="d-inline ms-2">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                    <i class="fas fa-trash"></i> {% trans "Remove Package" %}
                                </button>
                            </form>
                        </div>

                        <!-- ADJUST GUESTS COLLAPSE -->
                        <div class="collapse mt-3" id="adjust-guests-form-{{ order.pk }}">
                            <div class="card card-body bg-light">
                                <form method="post" action="{% url 'orders:update_template_guests' pk=order.pk %}" 
                                      id="guest-form-{{ order.pk }}" 
                                      class="guest-update-form">
                                    {% csrf_token %}
                                    <div class="mb-2">
                                        <label for="guest-count-{{ order.pk }}" class="form-label">{% trans "Number of Guests" %}</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="guest-count-{{ order.pk }}" 
                                                   name="guest_count" 
                                                   min="{{ order.template.default_guests }}" 
                                                   value="{{ order.template_guest_count }}" required>
                                            <button type="submit" class="btn btn-primary">{% trans "Update" %}</button>
                                        </div>
                                        <small class="form-text text-muted d-block mt-2">
                                            {% blocktrans with price=order.template.price_per_additional_guest currency=order.currency %}
                                                Additional guests: {{ price }} {{ currency }} each
                                            {% endblocktrans %}
                                        </small>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                    <div class="alert alert-info">
                        {% trans "No package selected yet. " %}<a href="{% url 'users:customer_template_list' %}">{% trans "Browse packages" %}</a>
                    </div>
                {% endif %}

                <!-- ADD-ON ITEMS -->
                {% if order.items.exists %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">{% trans "Add-On Items" %}</h4>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>{% trans "Service" %}</th>
                                        <th>{% trans "Item" %}</th>
                                        <th class="text-center">{% trans "Quantity" %}</th>
                                        <th class="text-end">{% trans "Unit Price" %}</th>
                                        <th class="text-end">{% trans "Subtotal" %}</th>
                                        <th class="text-center">{% trans "Actions" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in order.items.all %}
                                        <tr>
                                            <td>{{ forloop.counter }}</td>
                                            <td>{{ item.service.title }}</td>
                                            <td>{{ item.item.title }}</td>
                                            <td class="text-center">{{ item.quantity }}</td>
                                            <td class="text-end">{{ item.price_amount_at_order|floatformat:2 }} {{ item.price_currency_at_order }}</td>
                                            <td class="text-end">{{ item.subtotal_before_discount|floatformat:2 }} {{ item.price_currency_at_order }}</td>
                                            <td class="text-center">
                                                <a href="{% url 'orders:orderitem_update' order_pk=order.pk item_pk=item.pk %}" class="btn btn-sm btn-outline-warning">
                                                    <i class="fas fa-edit"></i> {% trans "Edit" %}
                                                </a>
                                                <a href="{% url 'orders:orderitem_delete' order_pk=order.pk item_pk=item.pk %}" class="btn btn-sm btn-outline-danger">
                                                    <i class="fas fa-trash"></i> {% trans "Remove" %}
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- TOTALS -->
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                {% if order.template_total_amount %}
                                    <p>{% trans "Package Total:" %} <strong>{{ order.template_total_amount|floatformat:2 }} {{ order.currency }}</strong></p>
                                {% endif %}
                                {% if order.items.exists %}
                                    <p>{% trans "Items Total:" %} <strong id="addon-total">0.00</strong> {{ order.currency }}</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6 text-md-end">
                                <h4>{% trans "Grand Total:" %} <span class="text-primary">{{ order.total_amount|floatformat:2 }} {{ order.currency }}</span></h4>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end mt-4 gap-2">
                            <a href="{% url 'orders:select_items' order_pk=order.pk %}" class="btn basket-btn-vue-2">
                                <i class="fas fa-plus"></i> {% trans "Add More Items" %}
                            </a>
                            <a href="{% url 'orders:order_detail' pk=order.pk %}" class="btn btn-success">
                                <i class="fas fa-check"></i> {% trans "Review Order" %}
                            </a>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="alert alert-info" role="alert">
                    {% trans "Your basket is currently empty." %}
                    {% if request.user.customer_profile %}
                        <br><a href="{% url 'users:customer_template_list' %}" class="alert-link">{% trans "Pick a Package to start" %}</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</main>
{% endblock %}

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Initialize Bootstrap collapse manually and handle form submission
    document.addEventListener('DOMContentLoaded', function() {
        // Find all guest update forms
        const guestForms = document.querySelectorAll('.guest-update-form');
        
        // Fallback: Toggle Adjust Guests collapse when Bootstrap JS isn't loaded
        const adjustButtons = document.querySelectorAll('[id^="adjust-guests-btn-"]');
        adjustButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                if (typeof bootstrap === 'undefined' || !bootstrap.Collapse) {  // FIX: Provide manual toggle when Bootstrap JS missing
                    const target = btn.getAttribute('data-bs-target');
                    const el = target ? document.querySelector(target) : null;
                    if (el) {
                        const isShown = el.classList.contains('show') || el.style.display === 'block';
                        el.classList.toggle('show', !isShown);
                        el.style.display = isShown ? 'none' : 'block';
                        e.preventDefault();
                    }
                }
            });
        });
        
        guestForms.forEach(form => {
            // Get the collapse element for this form
            const collapseId = form.id.replace('guest-form-', 'adjust-guests-form-');
            const collapseElement = document.getElementById(collapseId);
            
            if (collapseElement) {
                // Initialize Bootstrap collapse if available
                if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {  // FIX: Guard against missing Bootstrap JS
                    const bsCollapse = new bootstrap.Collapse(collapseElement, {
                        toggle: false  // Don't toggle on init
                    });
                }
                
                // Handle form submission - show loading state
                form.addEventListener('submit', function(e) {
                    e.preventDefault();  // Prevent default submission
                    
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{% trans "Updating..." %}';  // Show loading state
                    submitBtn.disabled = true;  // Disable button
                    
                    // Submit form via fetch for better UX
                    fetch(form.action, {  // FIX: Ensure same-origin credentials are sent for CSRF-protected POST
                        method: 'POST',
                        body: new FormData(form),
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        // Reload page to show updated values
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Error:', error);  // Log error to console
                        alert('{% trans "An error occurred. Please try again." %}');  // Show error message
                        submitBtn.innerHTML = originalText;  // Restore button
                        submitBtn.disabled = false;  // Re-enable button
                    });
                });
            }
        });
        
        // Calculate add-on items total
        const addonTotal = document.getElementById('addon-total');
        if (addonTotal) {
            let total = 0;
            const rows = document.querySelectorAll('table tbody tr');
            rows.forEach(row => {
                const subtotalCell = row.querySelector('td:nth-child(6)');
                if (subtotalCell) {
                    const amount = parseFloat(subtotalCell.textContent.replace(/[^0-9.-]+/g, ''));
                    total += isNaN(amount) ? 0 : amount;
                }
            });
            addonTotal.textContent = total.toFixed(2);
        }
    });
</script>

</body>
</html>