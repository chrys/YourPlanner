{% extends "core/base.html" %}
{% load i18n %}
{% load order_extras %}
{% load crispy_forms_tags %}

{% block title %}{{ page_title|default:"Order Details" }}{% endblock %}

{% block content %}
<div class="container mt-4">
    {% include "_messages.html" %}

    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3>{{ page_title|default:"Order Details" }}</h3>
                <div>
                    {% if order.status == "PENDING" and can_cancel_order %}  <!-- Check order status and permission -->
                        <a href="{% url 'orders:order_cancel' pk=order.pk %}" class="btn btn-sm btn-outline-danger">{% trans "Cancel Order" %}</a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>{% trans "Order ID" %}:</strong> {{ order.pk_formatted }}</p>
                    {# CHANGE: Handle agent-created orders without customer #}
                    <p><strong>{% trans "Customer" %}:</strong> 
                        {% if order.customer %}
                            {{ order.customer.user.get_full_name|default:order.customer.user.username }}
                        {% else %}
                            <small class="text-muted">{% trans "Not assigned" %}</small>
                        {% endif %}
                    </p>
                    <p><strong>{% trans "Email" %}:</strong> 
                        {% if order.customer %}
                            {{ order.customer.user.email }}
                        {% else %}
                            <small class="text-muted">—</small>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-6">
                    <p><strong>{% trans "Date Placed" %}:</strong> {{ order.created_at|date:"Y-m-d H:i:s" }}</p>
                    <p><strong>{% trans "Last Updated" %}:</strong> {{ order.updated_at|date:"Y-m-d H:i:s" }}</p>
                    <p><strong>{% trans "Status" %}:</strong> <span class="badge {% order_status_badge order.status %}">{{ order.get_status_display }}</span></p>
                </div>
            </div>
            {% if order.notes %}  <!-- Show customer notes if exist -->
                <p><strong>{% trans "Customer Notes" %}:</strong> {{ order.notes|linebreaksbr }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Display Template as a locked snapshot (not editable) -->
    {% if order.template %}  <!-- Check if template exists -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">
                <i class="fas fa-box"></i> {% trans "Package" %}: {{ order.template.title }}
            </h4>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <p><strong>{% trans "Base Price:" %}</strong> {{ order.template.base_price|floatformat:2 }} {{ order.currency }}</p>
                    <p><strong>{% trans "Guests:" %}</strong> {{ order.template_guest_count }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>{% trans "Package Price:" %}</strong></p>
                    <p class="h5 text-primary">{{ order.template_total_amount|floatformat:2 }} {{ order.currency }}</p>
                </div>
            </div>
            
            <!-- Show included services (locked, not editable) -->
            <div class="mt-3">
                <h5>{% trans "Included Services & Items" %}</h5>
                <ul class="list-group list-group-flush">
                    {% for service in order.template.services.all %}  <!-- Loop through template services -->
                        <li class="list-group-item">
                            <strong>{{ service.title }}</strong>
                            {% if service.items.all %}  <!-- Show items within each service -->
                                <ul class="list-unstyled ms-3 mt-2">
                                    {% for item in service.items.all %}
                                        <li><small>• {{ item.title }}</small></li>
                                    {% endfor %}
                                </ul>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Action buttons for template -->
            {% if order.status == "PENDING" %}  <!-- Only show if order is pending -->
            <div class="mt-3 pt-2 border-top">
                <button type="button" class="btn btn-sm btn-outline-info" id="adjust-guests-btn-{{ order.pk }}" data-bs-toggle="collapse" data-bs-target="#adjust-guests-form-{{ order.pk }}" aria-expanded="false" aria-controls="adjust-guests-form-{{ order.pk }}">  <!-- Added id for JS targeting and collapse toggle -->
                    <i class="fas fa-users"></i> {% trans "Adjust Guests" %}
                </button>
                
                <form method="post" action="{% url 'orders:remove_template' %}" class="d-inline ms-2">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                        <i class="fas fa-trash"></i> {% trans "Remove Package" %}
                    </button>
                </form>
            </div>

            <!-- Adjust guests form (collapsed) - ID must match data-bs-target -->
                        <div class="collapse mt-3" id="adjust-guests-form-{{ order.pk }}">  <!-- Unique ID with order.pk for collapse targeting -->
                            <div class="card card-body bg-light">
                                <form method="post" action="{% url 'orders:update_template_guests' pk=order.pk %}" id="guest-form-{{ order.pk }}" class="guest-update-form">  <!-- FIX: Correct malformed Django URL tag -->
                                    {% csrf_token %}
                                    <div class="mb-2">
                                        <label for="guest-count-{{ order.pk }}" class="form-label">{% trans "Number of Guests" %}</label>  <!-- FIX: Added label for clarity -->
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="guest-count-{{ order.pk }}" name="guest_count" min="{{ order.template.default_guests }}" value="{{ order.template_guest_count }}" required>  <!-- FIX: Moved all attributes on single line to prevent HTML rendering issues -->
                                            <button type="submit" class="btn btn-primary">{% trans "Update" %}</button>  <!-- FIX: Made button inline with input -->
                                        </div>
                                        <small class="form-text text-muted d-block mt-2">
                                            {% blocktrans with price=order.template.price_per_additional_guest currency=order.currency %}Additional guests: {{ price }} {{ currency }} each{% endblocktrans %}
                                        </small>
                                    </div>
                                </form>
                            </div>
                        </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Display add-on items section (only these are editable) -->
    <div class="card mb-4">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h4>
                    {% if order.template %}  <!-- Different header if template exists -->
                        {% trans "Add-On Items" %}
                    {% else %}
                        {% trans "Order Items" %}
                    {% endif %}
                </h4>
                {% if can_modify_items %}  <!-- Only show add button if items can be modified -->
                    <a href="{% url 'orders:select_items' order_pk=order.pk %}" class="btn btn-primary btn-sm">{% trans "Add/Modify Items" %}</a>
                {% endif %}
            </div>
        </div>
        <div class="card-body p-0">
            {% if order.items.exists %}  <!-- Show add-on items only -->
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">{% trans "Service" %}</th>
                                <th scope="col">{% trans "Item" %}</th>
                                <th scope="col" class="text-end">{% trans "Unit Price" %}</th>
                                <th scope="col" class="text-center">{% trans "Quantity" %}</th>
                                <th scope="col" class="text-end">{% trans "Subtotal" %}</th>
                                {% if can_modify_items %}  <!-- Actions column only if items can be modified -->
                                <th scope="col" class="text-center">{% trans "Actions" %}</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.items.all %}  <!-- Loop through add-on items only -->
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ item.service.title }}</td>
                                    <td>
                                        {{ item.item.title }}
                                        {% if item.price_description %}  <!-- Show price description if available -->
                                            <small class="d-block text-muted">{{ item.price_description }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">{{ item.price_amount_at_order|floatformat:2 }} {{ item.price_currency_at_order }}</td>
                                    <td class="text-center">{{ item.quantity }}</td>
                                    <td class="text-end">{{ item.subtotal_before_discount|floatformat:2 }} {{ item.price_currency_at_order }}</td>
                                    {% if can_modify_items %}  <!-- Edit/Delete actions only if items can be modified -->
                                    <td class="text-center">
                                        <a href="{% url 'orders:orderitem_update' order_pk=order.pk item_pk=item.pk %}" class="btn btn-sm btn-outline-warning">
                                            <i class="fas fa-edit"></i> {% trans "Edit" %}
                                        </a>
                                        <a href="{% url 'orders:orderitem_delete' order_pk=order.pk item_pk=item.pk %}" class="btn btn-sm btn-outline-danger ms-1">
                                            <i class="fas fa-trash"></i> {% trans "Remove" %}
                                        </a>
                                    </td>
                                    {% endif %}
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}  <!-- Show message if no add-on items -->
                <div class="p-3">
                    <p>{% trans "No add-on items have been added to this order yet." %}</p>
                    {% if can_modify_items %}  <!-- Show add button in message if allowed -->
                        <a href="{% url 'orders:select_items' order_pk=order.pk %}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> {% trans "Add Items" %}
                        </a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Order total summary -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    {% if order.template_total_amount %}  <!-- Display template total if exists -->
                        <p>{% trans "Package Total:" %} <strong>{{ order.template_total_amount|floatformat:2 }} {{ order.currency }}</strong></p>
                    {% endif %}
                    {% if order.items.exists %}  <!-- Display add-ons total if items exist -->
                        <p>{% trans "Items Total:" %} <strong id="addon-total">0.00</strong> {{ order.currency }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6 text-md-end">
                    <h4>{% trans "Grand Total:" %} <span class="text-primary">{{ order.total_amount|floatformat:2 }} {{ order.currency }}</span></h4>
                </div>
            </div>
        </div>
    </div>

    {% if can_update_status and status_update_form %}  <!-- Status update section for admins -->
    <div class="card mb-4">
        <div class="card-header">
            <h4>{% trans "Update Order Status" %} (Admin)</h4>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'orders:order_status_update' pk=order.pk %}">
                {% csrf_token %}
                {{ status_update_form|crispy }}
                <button type="submit" class="btn btn-info">{% trans "Update Status" %}</button>
            </form>
        </div>
    </div>
    {% endif %}

    <div class="mt-3">
        <a href="{% url 'orders:order_list' %}" class="btn btn-secondary">{% trans "Back to Order List" %}</a>
    </div>
</div>

<script>
    // Initialize Bootstrap collapse manually and handle form submission
    document.addEventListener('DOMContentLoaded', function() {
        // Find all guest update forms
        const guestForms = document.querySelectorAll('.guest-update-form');
        
        // Fallback: Toggle Adjust Guests collapse when Bootstrap JS isn't loaded
        const adjustButtons = document.querySelectorAll('[id^="adjust-guests-btn-"]');
        adjustButtons.forEach(btn => {
            btn.addEventListener('click', function(e) {
                if (typeof bootstrap === 'undefined' || !bootstrap.Collapse) {  // FIX: Provide manual toggle when Bootstrap JS missing
                    const target = btn.getAttribute('data-bs-target');
                    const el = target ? document.querySelector(target) : null;
                    if (el) {
                        const isShown = el.classList.contains('show') || el.style.display === 'block';
                        el.classList.toggle('show', !isShown);
                        el.style.display = isShown ? 'none' : 'block';
                        e.preventDefault();
                    }
                }
            });
        });
        
        guestForms.forEach(form => {
            // Get the collapse element for this form
            const collapseId = form.id.replace('guest-form-', 'adjust-guests-form-');
            const collapseElement = document.getElementById(collapseId);
            
            if (collapseElement) {
                // Initialize Bootstrap collapse if available
                if (typeof bootstrap !== 'undefined' && bootstrap.Collapse) {  // FIX: Guard against missing Bootstrap JS
                    const bsCollapse = new bootstrap.Collapse(collapseElement, {
                        toggle: false  // Don't toggle on init
                    });
                }
                
                // Handle form submission - show loading state
                form.addEventListener('submit', function(e) {
                    e.preventDefault();  // Prevent default submission
                    
                    const submitBtn = form.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{% trans "Updating..." %}';  // Show loading state
                    submitBtn.disabled = true;  // Disable button
                    
                    // Submit form via fetch for better UX
                    fetch(form.action, {  // FIX: Ensure same-origin credentials are sent for CSRF-protected POST
                        method: 'POST',
                        body: new FormData(form),
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        // Reload page to show updated values
                        window.location.reload();
                    })
                    .catch(error => {
                        console.error('Error:', error);  // Log error to console
                        alert('{% trans "An error occurred. Please try again." %}');  // Show error message
                        submitBtn.innerHTML = originalText;  // Restore button
                        submitBtn.disabled = false;  // Re-enable button
                    });
                });
            }
        });
        
        // Calculate add-on items total
        const addonTotal = document.getElementById('addon-total');
        if (addonTotal) {
            let total = 0;
            const rows = document.querySelectorAll('table tbody tr');
            rows.forEach(row => {
                const subtotalCell = row.querySelector('td:nth-child(6)');
                if (subtotalCell) {
                    const amount = parseFloat(subtotalCell.textContent.replace(/[^0-9.-]+/g, ''));
                    total += isNaN(amount) ? 0 : amount;
                }
            });
            addonTotal.textContent = total.toFixed(2);
        }
    });
</script>
{% endblock %}