{% extends "core/base.html" %}
{% load static %} {# For Vue.js script if served locally #}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>{{ page_title }}</h1>

    <div id="agent-orders-app">
        <!-- Vue.js app will mount here -->
        <div v.if="isLoading">Loading orders...</div>
        <div v.if="error" class="alert alert-danger">{{ error }}</div>
        <table v-if="!isLoading && !error && orders.length > 0" class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Summary</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th>Date</th>
                    <th>Labels</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="order in orders" :key="order.id">
                    <td>#{{ order.id }}</td>
                    <td>{{ order.title }}</td>
                    <td>{{ order.status }}</td>
                    <td>{{ order.total_amount }} {{ order.currency_symbol }}</td>
                    <td>{{ order.order_date }}</td>
                    <td>
                        <span v-for="label in order.labels" :key="label.name" class="badge me-1" :style="{ backgroundColor: label.color, color: label.text_color }">
                            {{ label.name }}
                        </span>
                        <span v-if="!order.labels || order.labels.length === 0" class="text-muted fst-italic">No labels</span>
                    </td>
                    <td>
                        <a :href="order.edit_url" class="btn btn-sm btn-primary">Edit</a>
                        <button @click="deleteOrder(order.id)" class="btn btn-sm btn-danger ms-1">Delete</button>
                    </td>
                </tr>
            </tbody>
        </table>
        <div v-if="!isLoading && !error && orders.length === 0" class="alert alert-info">You have no orders yet.</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{# Vue.js CDN for now, or link to local static file if Vue is part of the project build #}
<script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
<script>
    const ordersApiUrl = "{{ orders_api_url|escapejs }}"; // Pass URL to JS

    const AgentOrdersApp = {
        data() {
            return {
                orders: [],
                isLoading: true,
                error: null
            };
        },
        mounted() {
            this.fetchOrders();
        },
        methods: {
            async fetchOrders() {
                this.isLoading = true;
                this.error = null;
                try {
                    const response = await fetch(ordersApiUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    this.orders = data.orders;
                } catch (e) {
                    console.error("Failed to fetch orders:", e);
                    this.error = "Failed to load orders. Please try again later.";
                } finally {
                    this.isLoading = false;
                }
            },
            deleteOrder(orderId) {
                    if (confirm('Are you sure you want to delete this order?')) {
                        const deleteUrl = `/orders/api/agent/order/${orderId}/delete/`; // Corrected URL path
                        const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '{{ csrf_token }}';

                        this.isLoading = true;
                        fetch(deleteUrl, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrfToken,
                                'Content-Type': 'application/json'
                            },
                        })
                        .then(response => {
                            if (!response.ok) {
                                // Try to parse error from JSON body, then fallback to status text
                                return response.json().then(err => {
                                    throw new Error(err.error || `HTTP error! status: ${response.statusText || response.status}`);
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                this.fetchOrders(); // Refresh the list
                            } else {
                                alert(data.error || 'Failed to delete order.');
                            }
                        })
                        .catch(error => {
                            console.error('Error deleting order:', error);
                            alert(`Error: ${error.message || 'Could not connect to server or other error.'}`);
                        })
                        .finally(() => {
                            this.isLoading = false;
                        });
                    }
            }
        },
        template: `
            <div v.if="isLoading">Loading orders...</div>
            <div v.if="error" class="alert alert-danger">{{ error }}</div>
            <table v-if="!isLoading && !error && orders.length > 0" class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Summary</th>
                        <th>Status</th>
                        <th>Total</th>
                        <th>Date</th>
                        <th>Labels</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="order in orders" :key="order.id">
                        <td>#{{ order.id }}</td>
                        <td>{{ order.title }}</td>
                        <td>{{ order.status }}</td>
                        <td>{{ order.total_amount }} {{ order.currency_symbol }}</td>
                        <td>{{ order.order_date }}</td>
                        <td>
                            <span v-for="label in order.labels" :key="label.name" class="badge me-1" :style="{ backgroundColor: label.color, color: label.text_color }">
                                {{ label.name }}
                            </span>
                            <span v-if="!order.labels || order.labels.length === 0" class="text-muted fst-italic">No labels</span>
                        </td>
                        <td>
                            <a :href="order.edit_url" class="btn btn-sm btn-primary">Edit</a>
                            <button @click="deleteOrder(order.id)" class="btn btn-sm btn-danger ms-1">Delete</button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div v-if="!isLoading && !error && orders.length === 0" class="alert alert-info">You have no orders yet.</div>
        `
    };

    Vue.createApp(AgentOrdersApp).mount('#agent-orders-app');
</script>
{% endblock %}
