{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Wedding Timeline</h1>
    
    <div class="row">
        <div class="col-lg-8">
            <form method="post" action="{% url 'users:wedding_timeline_update' %}" class="needs-validation" novalidate>
                {% csrf_token %}
                
                <!-- CHANGED: Event Details Section moved to first -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Event Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_event_organiser_name" class="form-label">{{ form.event_organiser_name.label }}</label>
                                {{ form.event_organiser_name }}
                                {% if form.event_organiser_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.event_organiser_name.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_contact_number" class="form-label">{{ form.contact_number.label }}</label>
                                {{ form.contact_number }}
                                {% if form.contact_number.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.contact_number.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_pre_wedding_appointment" class="form-label">{{ form.pre_wedding_appointment.label }}</label>
                                {{ form.pre_wedding_appointment }}
                                {% if form.pre_wedding_appointment.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.pre_wedding_appointment.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_location" class="form-label">{{ form.location.label }}</label>
                                {{ form.location }}
                                {% if form.location.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.location.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check mt-4">
                                    {{ form.apostille_stamp }}
                                    <label for="id_apostille_stamp" class="form-check-label">
                                        {{ form.apostille_stamp.label }}
                                    </label>
                                    {% if form.apostille_stamp.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.apostille_stamp.errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_ceremony_admin" class="form-label">{{ form.ceremony_admin.label }}</label>
                                {{ form.ceremony_admin }}
                                {% if form.ceremony_admin.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.ceremony_admin.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CHANGED: Bride & Groom Information Section with all required fields -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Bride & Groom Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_bride_name" class="form-label">{{ form.bride_name.label }}</label>
                                {{ form.bride_name }}
                                {% if form.bride_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.bride_name.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_groom_name" class="form-label">{{ form.groom_name.label }}</label>
                                {{ form.groom_name }}
                                {% if form.groom_name.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.groom_name.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_wedding_day_display" class="form-label">{{ form.wedding_day_display.label }}</label>
                                {{ form.wedding_day_display }}
                                {% if form.wedding_day_display.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.wedding_day_display.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_bride_contact" class="form-label">{{ form.bride_contact.label }}</label>
                                {{ form.bride_contact }}
                                {% if form.bride_contact.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.bride_contact.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="id_groom_contact" class="form-label">{{ form.groom_contact.label }}</label>
                                {{ form.groom_contact }}
                                {% if form.groom_contact.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.groom_contact.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="id_emergency_contact" class="form-label">{{ form.emergency_contact.label }}</label>
                                {{ form.emergency_contact }}
                                {% if form.emergency_contact.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.emergency_contact.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="id_planner" class="form-label">{{ form.planner.label }}</label>
                                {{ form.planner }}
                                {% if form.planner.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.planner.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="id_special_notes" class="form-label">{{ form.special_notes.label }}</label>
                                {{ form.special_notes }}
                                {% if form.special_notes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.special_notes.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Guest Numbers Section -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">Guest Numbers</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="id_adults" class="form-label">{{ form.adults.label }}</label>
                                {{ form.adults }}
                                {% if form.adults.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.adults.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="id_children" class="form-label">{{ form.children.label }}</label>
                                {{ form.children }}
                                {% if form.children.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.children.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="id_babies" class="form-label">{{ form.babies.label }}</label>
                                {{ form.babies }}
                                {% if form.babies.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.babies.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="alert alert-info" role="alert">
                            <strong>Total Guests:</strong> 
                            <span id="total_guests">
                                {% if timeline %}
                                    {{ timeline.total_guests }}
                                {% else %}
                                    0
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Form Buttons -->
                <div class="mb-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Timeline
                    </button>
                    <a href="{% url 'users:customer_management' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Back to Management
                    </a>
                </div>
            </form>
        </div>

        <!-- Sidebar with Customer Information -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Wedding Information</h5>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-6">Wedding Day:</dt>
                        <dd class="col-sm-6">
                            {% if customer.wedding_day %}
                                {{ customer.wedding_day|date:"M d, Y" }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-6">Bride:</dt>
                        <dd class="col-sm-6">
                            {% if customer.bride_name %}
                                {{ customer.bride_name }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-6">Groom:</dt>
                        <dd class="col-sm-6">
                            {% if customer.groom_name %}
                                {{ customer.groom_name }}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </dd>

                        <dt class="col-sm-6">Planner:</dt>
                        <dd class="col-sm-6">
                            {% if customer.planner %}
                                {{ customer.planner }}
                            {% else %}
                                <span class="text-muted">Not assigned</span>
                            {% endif %}
                        </dd>
                    </dl>

                    {% if customer.special_notes %}
                        <div class="mt-3">
                            <h6>Special Notes</h6>
                            <p class="text-muted" style="white-space: pre-wrap;">{{ customer.special_notes }}</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // CHANGED: Update total guests whenever guest numbers change - made defensive
    document.addEventListener('DOMContentLoaded', function() {
        const adultsInput = document.getElementById('id_adults');
        const childrenInput = document.getElementById('id_children');
        const babiesInput = document.getElementById('id_babies');
        const totalGuestsSpan = document.getElementById('total_guests');

        // CHANGED: Only set up listeners if all elements exist
        if (!adultsInput || !childrenInput || !babiesInput || !totalGuestsSpan) {
            console.warn('Guest number inputs not found in DOM');
            return;
        }

        function updateTotal() {
            const adults = parseInt(adultsInput.value || 0);
            const children = parseInt(childrenInput.value || 0);
            const babies = parseInt(babiesInput.value || 0);
            totalGuestsSpan.textContent = adults + children + babies;
        }

        adultsInput.addEventListener('change', updateTotal);
        childrenInput.addEventListener('change', updateTotal);
        babiesInput.addEventListener('change', updateTotal);
    });
</script>
{% endblock %}
