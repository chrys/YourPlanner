{% extends "core/base.html" %}
{% load i18n static %}
{% load crispy_forms_tags %} 
{% block title %}{% if object %}{% trans "Edit Template" %}{% else %}{% trans "Create Template" %}{% endif %}{% endblock title %}

{% block extra_head %}
    {{ form.media }}
    {{ image_formset.media }}
    {{ group_formset.media }}  <!-- Added group formset media -->
{% endblock extra_head %}

{% block content %}
<div class="container mt-4">
    <h2>{% if object %}{% trans "Edit Template" %}: {{ object.title }}{% else %}{% trans "Create New Template" %}{% endif %}</h2>

    {% if form.errors or image_formset.errors or group_formset.errors %}  <!-- Added group_formset.errors -->
        <div class="alert alert-danger">
            <p>{% trans "Please correct the errors below:" %}</p>
            {{ form.non_field_errors }}
            {{ image_formset.non_form_errors }}
            {{ group_formset.non_form_errors }}  <!-- Show group formset errors -->
        </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data" id="template-form">
        {% csrf_token %}

        <!-- Basic Template Information -->
        <div class="card mb-3">
            <div class="card-header">{% trans "Package Details" %}</div>
            <div class="card-body">
                {{ form.title|as_crispy_field }}
                {{ form.description|as_crispy_field }}
                {{ form.services|as_crispy_field }}
                {{ form.base_price|as_crispy_field }}
                {{ form.currency|as_crispy_field }}
                {{ form.default_guests|as_crispy_field }}
                {{ form.price_per_additional_guest|as_crispy_field }}
            </div>
        </div>

        <!-- Item Groups Section -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>{% trans "Item Groups" %}</span>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="id_number_of_groups" class="form-label">{% trans "Number of Item Groups" %}</label>
                    {{ form.number_of_groups }}
                    <div class="form-text">{% trans "Specify how many groups of items you want to create" %}</div>
                </div>
                <button type="button" id="generate-groups-btn" class="btn btn-outline-primary mt-2">
                    {% trans "Generate Groups" %}
                </button> 
                <div id="item-groups-container">
                    {{ group_formset.management_form }}
                    {% for group_form in group_formset %}
                        <div class="item-group-form card mb-3" data-group-index="{{ forloop.counter0 }}">
                            <div class="card-header">
                                <strong>{% trans "Group" %} {{ forloop.counter }}</strong>
                                {% if group_form.instance.pk %}
                                    <button type="button" class="btn btn-sm btn-danger float-end delete-group-btn">
                                        {% trans "Delete Group" %}
                                    </button>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                {{ group_form.id }}
                                <div class="mb-3">
                                    <label class="form-label">{{ group_form.name.label }}</label>
                                    {{ group_form.name }}
                                    {% if group_form.name.errors %}
                                        <div class="text-danger">{{ group_form.name.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ group_form.mandatory_count.label }}</label>
                                    {{ group_form.mandatory_count }}
                                    <div class="form-text">{{ group_form.mandatory_count.help_text }}</div>
                                    {% if group_form.mandatory_count.errors %}
                                        <div class="text-danger">{{ group_form.mandatory_count.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">{{ group_form.items.label }}</label>
                                    <div class="row">
                                        {% for checkbox in group_form.items %}
                                            <div class="col-md-4 mb-2">
                                                <div class="form-check">
                                                    {{ checkbox.tag }}
                                                    <label class="form-check-label" for="{{ checkbox.id_for_label }}">
                                                        {{ checkbox.choice_label }}
                                                    </label>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <div class="form-text">{{ group_form.items.help_text }}</div>
                                    {% if group_form.items.errors %}
                                        <div class="text-danger">{{ group_form.items.errors }}</div>
                                    {% endif %}
                                </div>
                                {{ group_form.DELETE }}
                            </div>
                        </div>
                    {% endfor %}
                    <!-- Hidden container with all available items as checkboxes for JS cloning -->
                    <div id="all-items-checkboxes" class="d-none">
                        {# Use all_items context variable, which must be provided by the view #}
                        {% for item in all_items %}
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" name="items" value="{{ item.pk }}" id="item-checkbox-{{ item.pk }}">
                            <label class="form-check-label" for="item-checkbox-{{ item.pk }}">{{ item }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    <!-- Add a hidden template for new groups -->
                    <div class="item-group-form card mb-3 d-none" id="group-form-template">
                        <div class="card-header">
                            <strong>Group X</strong>
                        </div>
                        <div class="card-body">
                            <!-- Add empty fields as in your real group form -->
                            <div class="mb-3">  <!-- group name field stays in hidden template -->
                                <label class="form-label">Group Name</label>
                                <input type="text" class="form-control" name="name" value="" />  <!-- JS will rename to groups-{index}-name -->
                            </div>
                            <div class="mb-3">  <!-- mandatory count field stays in hidden template -->
                                <label class="form-label">Mandatory Items Count</label>
                                <input type="number" class="form-control" name="mandatory_count" value="0" min="0" />  <!-- JS will rename to groups-{index}-mandatory_count -->
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Items</label>
                                <div class="row items-checkboxes-row">
                                    <!-- JS will populate checkboxes here from #all-items-checkboxes -->
                                </div>
                                <div class="form-text">Select items for this group</div>
                            </div>
                            <input type="checkbox" name="DELETE" style="display:none;" />  <!-- JS will rename to groups-{index}-DELETE -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Images Section (unchanged) -->
        <div class="card mb-3">
            <div class="card-header">{% trans "Images" %}</div>
            <div class="card-body">
                {{ image_formset.management_form }}
                {% for image_form in image_formset %}
                    <div class="image-form mb-3 p-3 border rounded">
                        {{ image_form.id }}
                        <div class="row">
                            <div class="col-md-8">
                                {{ image_form.image|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                <div class="form-check mt-4">
                                    {{ image_form.is_default }}
                                    <label class="form-check-label" for="{{ image_form.is_default.id_for_label }}">
                                        {% trans "Set as default image" %}
                                    </label>
                                </div>
                                {% if image_form.instance.pk %}
                                    <div class="form-check mt-2">
                                        {{ image_form.DELETE }}
                                        <label class="form-check-label text-danger" for="{{ image_form.DELETE.id_for_label }}">
                                            {% trans "Delete this image" %}
                                        </label>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% if image_form.instance.image %}
                            <div class="mt-2">
                                <img src="{{ image_form.instance.image.url }}" alt="{% trans 'Current image' %}" class="img-thumbnail" style="max-height: 150px;">
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <div class="mb-3">
            <button type="submit" class="btn btn-primary">
                {% if object %}{% trans "Update Template" %}{% else %}{% trans "Create Template" %}{% endif %}
            </button>
            <a href="{% url 'packages:template-list' %}" class="btn btn-secondary">{% trans "Cancel" %}</a>
        </div>
    </form>
</div>

<!-- JavaScript to handle dynamic group forms -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const numberInput = document.getElementById('id_number_of_groups');
    const groupsContainer = document.getElementById('item-groups-container');
    const managementForm = document.querySelector('input[name="groups-TOTAL_FORMS"]');
    const generateBtn = document.getElementById('generate-groups-btn'); // Get the button
    const allItemsContainer = document.getElementById('all-items-checkboxes'); // Get the items container
    
    if (!numberInput || !groupsContainer || !managementForm || !generateBtn) return;  // guard required elements

    // Get the first existing group form as a template (if it exists)
    let templateForm = groupsContainer.querySelector('.item-group-form:not(#group-form-template)');
    
    function updateGroupForms() {
        const targetCount = parseInt(numberInput.value) || 0;
        const existingForms = Array.from(groupsContainer.querySelectorAll('.item-group-form:not(#group-form-template)'));
        const currentCount = existingForms.length;

        // Show/hide existing forms based on target
        existingForms.forEach((form, index) => {
            if (index < targetCount) {
                form.style.display = '';
                // Update the group number in header
                const header = form.querySelector('.card-header strong');
                if (header) {
                    header.textContent = `{% trans "Group" %} ${index + 1}`;
                }
            } else {
                form.style.display = 'none';
            }
        });

        // Add new forms if needed
        if (targetCount > currentCount) {
            for (let i = currentCount; i < targetCount; i++) {
                addNewGroupForm(i);
            }
        }
        
        // Update management form count to match requested number
        managementForm.value = targetCount;  // keep TOTAL_FORMS in sync with visible count
    }

    // Populate items into a group's items container from the hidden all-items list
    function populateItemsCheckboxes(targetForm, index) {
        const itemsRow = targetForm.querySelector('.items-checkboxes-row');  // container inside group form
        if (!itemsRow || !allItemsContainer) return;  // nothing to populate if missing

        itemsRow.innerHTML = '';  // clear before inserting

        const sources = allItemsContainer.querySelectorAll('.form-check');
        sources.forEach((srcDiv) => {
            const srcInput = srcDiv.querySelector('input[type="checkbox"]');
            const srcLabel = srcDiv.querySelector('label');
            if (!srcInput || !srcLabel) return;

            const col = document.createElement('div');
            col.className = 'col-md-4 mb-2';
            const formCheck = document.createElement('div');
            formCheck.className = 'form-check';

            const input = document.createElement('input');
            input.type = 'checkbox';
            input.className = 'form-check-input';
            input.value = srcInput.value;
            input.name = `groups-${index}-items`;  // formset-compliant name
            input.id = `id_groups-${index}-items_${srcInput.value}`;  // unique id per item

            const label = document.createElement('label');
            label.className = 'form-check-label';
            label.setAttribute('for', input.id);
            label.textContent = srcLabel.textContent;

            formCheck.appendChild(input);
            formCheck.appendChild(label);
            col.appendChild(formCheck);
            itemsRow.appendChild(col);
        });
    }

    function addNewGroupForm(index) {
        // Use the first form as template, or create from scratch
        if (!templateForm && !allItemsContainer) {
            console.error('No template form or items found');
            return;
        }

        let newForm;
        if (templateForm) {
            // Clone existing form with all items
            newForm = templateForm.cloneNode(true);
        } else {
            // Create new form from hidden template
            const hiddenTemplate = document.getElementById('group-form-template');
            if (!hiddenTemplate) return;
            newForm = hiddenTemplate.cloneNode(true);
            newForm.classList.remove('d-none');  // make visible
            newForm.removeAttribute('id');  // remove template id
            // explicitly set names/ids for hidden-template fields to formset names
            const nameInput = newForm.querySelector('input[name="name"]');
            if (nameInput) {
                nameInput.name = `groups-${index}-name`;  // CHANGE
                nameInput.id = `id_groups-${index}-name`;  // CHANGE
                const nameLabel = nameInput.closest('.mb-3')?.querySelector('label.form-label');
                if (nameLabel) nameLabel.setAttribute('for', nameInput.id);  // CHANGE
            }
            const mandatoryInput = newForm.querySelector('input[name="mandatory_count"]');
            if (mandatoryInput) {
                mandatoryInput.name = `groups-${index}-mandatory_count`;  // CHANGE
                mandatoryInput.id = `id_groups-${index}-mandatory_count`;  // CHANGE
                const mLabel = mandatoryInput.closest('.mb-3')?.querySelector('label.form-label');
                if (mLabel) mLabel.setAttribute('for', mandatoryInput.id);  // CHANGE
            }
            const deleteInput = newForm.querySelector('input[name="DELETE"]');
            if (deleteInput) {
                deleteInput.name = `groups-${index}-DELETE`;  // CHANGE
                deleteInput.id = `id_groups-${index}-DELETE`;  // CHANGE
            }
            // populate items checkboxes from hidden source
            populateItemsCheckboxes(newForm, index);
        }
        
        newForm.setAttribute('data-group-index', index);
        newForm.setAttribute('data-generated', 'true'); // Mark as generated
        newForm.style.display = '';
        
        // Update all field names and IDs to use the new index
        const fields = newForm.querySelectorAll('input, select, textarea, label');
        fields.forEach(field => {
            // Update name attribute
            if (field.hasAttribute('name')) {
                const name = field.getAttribute('name');
                field.setAttribute('name', name.replace(/groups-\d+/, `groups-${index}`));
            }
            
            // Update id attribute
            if (field.hasAttribute('id')) {
                const id = field.getAttribute('id');
                field.setAttribute('id', id.replace(/groups-\d+/, `groups-${index}`));
            }
            
            // Update for attribute (for labels)
            if (field.hasAttribute('for')) {
                const forAttr = field.getAttribute('for');
                field.setAttribute('for', forAttr.replace(/groups-\d+/, `groups-${index}`));
            }
            
            // Clear values for input fields
            if (field.tagName === 'INPUT') {
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else if (field.type === 'text' || field.type === 'number') {
                    if (!field.name.includes('TOTAL_FORMS') && !field.name.includes('INITIAL_FORMS')) {
                        field.value = field.name.includes('mandatory_count') ? '0' : '';
                    }
                } else if (field.type === 'hidden' && !field.name.includes('-id')) {
                    field.value = '';
                }
            } else if (field.tagName === 'TEXTAREA') {
                field.value = '';
            }
        });

        // Update the group header
        const header = newForm.querySelector('.card-header strong');
        if (header) {
            header.textContent = `{% trans "Group" %} ${index + 1}`;
        }

        // Remove the delete button if it exists (new forms shouldn't have delete for existing items)
        const deleteBtn = newForm.querySelector('.delete-group-btn');
        const idField = newForm.querySelector('input[name$="-id"]');
        if (deleteBtn && (!idField || !idField.value)) {
            deleteBtn.remove();
        }

        // Append the new form to the container (before hidden template if it exists)
        const hiddenTemplate = document.getElementById('group-form-template');
        if (hiddenTemplate) {
            groupsContainer.insertBefore(newForm, hiddenTemplate);
        } else {
            groupsContainer.appendChild(newForm);
        }
    }

    // Only update groups when button is clicked
    generateBtn.addEventListener('click', updateGroupForms);

    // Handle delete buttons
    groupsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('delete-group-btn')) {
            const form = e.target.closest('.item-group-form');
            const deleteCheckbox = form.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                form.style.display = 'none';
                const currentValue = parseInt(numberInput.value) || 0;
                numberInput.value = Math.max(0, currentValue - 1);
            }
        }
    });
});
</script>
{% endblock content %}